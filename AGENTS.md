# AGENTS

## Telegram Club Bot — Spec Snapshot & Audit Rules

=== SPEC SNAPSHOT (17 блоков, чек-лист требований) ===
Блок 1 RBAC: роли {Owner, Главный админ, Главный менеджер, Менеджер клуба, Менеджер зала, Host/Вход, Админ клуба, Финансовый менеджер, Промоутер (глобальный), DJ, Гость}. Scope GLOBAL/CLUB. Ограничения прав, опасные операции требуют причины и аудита.
Блок 2 Календарь: правила по дням недели + исключения/праздники; TZ клуба; “ночь” может пересекать сутки; показываем только рабочие ночи; cut-off брони = конец ночи − 2 часа (настраиваемо); уведомления об изменениях календаря.
Блок 3 Витрина: список клубов, карточка клуба (описание, адрес, афиши, фото, музыка), CTA “Забронировать стол”, “Задать вопрос”.
Блок 4 Бронирование: поток клуб/дата → схема → стол → HOLD (TTL) → гости → депозит → контакты → правила → confirm. HOLD один одновременно. Удержание брони 30 мин после времени прихода. Продление удержания только менеджером. Отмена до последнего момента + напоминание “скоро слетит”.
Блок 5 Mini App UX: разделы гостя (карта, календарь, мои брони, Night Pass, мои ночи, музыка, вопрос, уведомления) + разделы персонала (вход/сканер, столы) + управленцев (настройки/отчёты/контент). Фолбэки в чат при сбоях.
Блок 6 Вход и списки: промо создаёт GuestList (вставить списком и по одному), приглашения: внутренние (если гость уже запускал бота) и внешние (deeplink+QR). Check-in: один Night Pass QR; защита от повторного скана/пересылки; статусы ARRIVED/DENIED(/LATE/SEATED если есть); причины отказа; поиск по ФИО/@username/тел.
Блок 7 Столы (операционка): статусы столов; посадка; спонтанные столы; режимы “депозит / по счёту / от клуба”; депозит операциями (первичный + доплаты), отдельная статья “охрана”; распределение депозита (бар/кухня/кальян vs шары, 50/50 если включено); освобождение стола; no-show; стоп продаж столов + Undo.
Блок 8 Финансы смены: смена открывается автоматически; закрывает только финансист клуба; люди (жен/муж/отказы), браслеты (типы настраиваемые), выручка (статьи настраиваемые) с флагом “в общую/не в общую”; депозитные карты отдельной метрикой “не в общую”; сверка со столами; после закрытия смены данные замораживаются.
Блок 9 Геймификация: штампы ночей по клубу; ранний приход (время настраиваемо по клубу/ночи); бейджи с порогами и русскими названиями; mystery-upgrade; розыгрыши (условия: посещения/ранние/столы, период); лояльность по столам (накопительная, настраиваемая). Начисление только по check-in; защита от дублей.
Блок 10 “Задать вопрос”: категории, тикеты NEW/IN_PROGRESS/WAITING/RESOLVED/CLOSED, связь с клубом/ночью/бронью, ответы админов.
Блок 11 Музыка и DJ: загрузка треков/сетов файлами, модерация, плейлисты, “главный трек ночи”, голосования/реакции, избранное, поддержка (донаты/чаевые), статистика.
Блок 12 Коммуникации: уведомления календаря, ручные рассылки с сегментацией, посты в канал, лимиты анти-спам, афиши/фото/сеты как контент.
Блок 13 Статистика: дашборды (брони/столы/вход/промо/финансы/геймификация/музыка/коммуникации/саппорт), карточка ночи 360°, экспорт, авто-отчёты.
Блок 14 Регламент: чек-листы смены, золотые правила, дисциплина “одна отметка”, работа при пике и базовый аварийный протокол.
Блок 15 Админ‑настройки и масштабирование: добавление клуба без правок кода (профиль/календарь/столы/схема/hotspots/правила/финансы/коммуникации/модули/роли), шаблоны/клонирование, аудит изменений конфигурации.
Блок 16 Сбои: уровни деградации, фолбэки (карта→список, QR→поиск/журнал), ручные журналы, восстановление после сбоя.
Блок 17 Безопасность: webhook secret, валидация initData Mini App, RBAC, идемпотентность операций, PII-минимизация и маскирование, аудит-лог, антифрод промо и персонала.

=== INVARIANTS (нельзя ломать) ===
- Один Night Pass (QR) на ночь: не показывать два QR гостю.
- Один check-in на пользователя на ночь. Повторный скан не создаёт дубль.
- Нельзя иметь два HOLD одновременно.
- Депозиты/доплаты/охрана — только через операции, без “перезаписи итоговой суммы”.
- После закрытия смены финансы заморожены, правки только через супер-роль + причина + аудит.

=== REPO DELIVERY RULES (обязательно для всех задач) ===

### Definition of Done (DoD)
- Изменение считается завершённым только если выполнены все пункты:
  1. Обновлён production-код.
  2. Добавлены/обновлены тесты под изменённое поведение.
  3. Выполнены проверки Gradle и зафиксирован результат (pass/fail с причиной).
- Минимум для локальной проверки: `./gradlew test`.
- Для задач по hardening и readiness дополнительно прогонять lint/static/IT набор.

### Engineering standards
- Kotlin style: соблюдаем `ktlint`; читаемый и явный код без скрытой магии.
- Static analysis: `detekt` обязателен для новых/изменённых участков.
- Коррутины: не проглатывать `CancellationException` через `catch (Throwable/Exception)`; если перехват широкого типа неизбежен — `CancellationException` обязательно rethrow.
- Единый формат API ошибок: не вводить ad-hoc структуры, использовать общий error envelope проекта.

### Security guardrails (prod/stage)
- Все security-critical проверки работают в режиме fail-closed для `prod`/`stage`.
- Запрещено логировать чувствительные данные: `initData`, любые секреты, `qrSecret`, `Idempotency-Key`.
- Использование `initData` в query-string в `prod` запрещено (допускаются только безопасные каналы передачи, принятые в проекте).
- Любые исключения из правил выше требуют явного обоснования, теста и записи в документации.

### Test requirements for risky areas
- Любые изменения в `routing`, `security`, `payments` обязаны сопровождаться:
  - тестами через Ktor test host;
  - и (где есть работа с БД/транзакциями/блокировками) интеграционными тестами на Postgres.

### Recommended commands
- Базовый прогон: `./gradlew clean test`
- Интеграционные тесты: `./gradlew test -PrunIT=true`
- Линт и статанализ: `./gradlew detekt ktlintCheck`
- Форматирование + проверки + тесты: `scripts/verify.sh`
- CI-like прогон локально: `scripts/verify.sh ci`
