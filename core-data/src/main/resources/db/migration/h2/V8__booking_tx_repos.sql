ALTER TABLE audit_log
    ADD COLUMN IF NOT EXISTS result TEXT DEFAULT 'UNKNOWN' NOT NULL;

CREATE TABLE IF NOT EXISTS booking_outbox (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    topic TEXT NOT NULL,
    payload JSON NOT NULL,
    status TEXT NOT NULL DEFAULT 'NEW',
    attempts INT NOT NULL DEFAULT 0,
    next_attempt_at TIMESTAMP WITH TIME ZONE NOT NULL,
    last_error TEXT NULL,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP(),
    CHECK (status IN ('NEW', 'SENT', 'FAILED'))
);

CREATE INDEX IF NOT EXISTS idx_booking_outbox_status_attempt
    ON booking_outbox(status, next_attempt_at);
