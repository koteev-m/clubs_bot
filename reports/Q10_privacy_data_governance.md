# Q10 — Privacy & Data Governance Audit (PII)

## Scope
Аудит выполнен без изменений кода по направлениям:
- инвентаризация PII (телефон, имя, username);
- согласие на телефон (`request_contact`);
- видимость телефона и маскирование;
- retention / TTL / очистка / анонимизация;
- риски утечки в логах и чат-уведомлениях;
- ограничения экспорта по ролям;
- наличие механизма удаления/анонимизации пользователя.

---

## 1) Инвентаризация PII

| Поле PII | Где хранится | Кто видит | Маскирование |
|---|---|---|---|
| `users.phone_e164` | `users.phone_e164` (SQL схема + Exposed table) | Прямые API чтения телефона из `UserRepository` не найдены; поле сохраняется при веб-брони и может использоваться внутренними сервисами/запросами | На уровне API/UI маскирование для этого поля не найдено; в логах есть regex-маскирование телефонов |
| `users.display_name` | `users.display_name` | Используется в пользовательских/служебных потоках; может попадать в Telegram-уведомления HQ | Лог-маскирование частично (по шаблонам `name=...`), но не универсально для всех текстов |
| `users.username` | `users.username` | Используется в интерфейсе и некоторых админ/операционных ответах | Спец-маски для username не найдено |
| `bookings.guest_name` | `bookings.guest_name` | Операционные и пользовательские потоки бронирования | Спец-маски в API-ответах не найдено |
| `bookings.phone_e164` | `bookings.phone_e164` | Сохраняется при создании бронирования в web app; потенциально доступно через прямые DB-доступы/внутренние инструменты | Спец-маски в API-ответах не найдено |
| `guest_list_entries.full_name` | `guest_list_entries.full_name` | Видят авторизованные роли guest-list API; экспортируется в CSV | В API/CSV отдается как есть (без маски) |
| `guest_list_entries.tg_username` | `guest_list_entries.tg_username` | Доступно в БД и внутренних сценариях гостевых списков | Маскирование не найдено |
| `guest_list_entries.phone_e164` | `guest_list_entries.phone_e164` | Авторизованные роли guest-list API + CSV export | В API/CSV отдается как есть (без маски) |

Примечания:
- `UserRepository` интерфейс сейчас не предоставляет методов удаления/анонимизации; только `getByTelegramId/getById`.
- Для guest-list есть role-gated доступ и клубный scope, но внутри разрешенных ролей телефон экспортируется в открытом виде.

---

## 2) Согласие на телефон (`request_contact`)

### Фактическое поведение
- В booking web app телефон собирается обычным полем `<input type="tel">` и отправляется как `phoneE164` в JSON.
- Использование Telegram-кнопки `request_contact` в кодовой базе не найдено.

### Вывод
- **Явного Telegram consent-flow через `request_contact` нет.**
- Сейчас consent де-факто «подразумевается» фактом ручного ввода номера, что слабо для privacy compliance.

---

## 3) Кто видит телефон и где маскируется

### Кто видит
- `GET /api/guest-lists` и `GET /api/guest-lists/export` доступны ролям:
  `OWNER`, `GLOBAL_ADMIN`, `HEAD_MANAGER`, `CLUB_ADMIN`, `MANAGER`, `ENTRY_MANAGER`, `PROMOTER`.
- Ответ/экспорт включает поле `phone` без обфускации.
- Для `PROMOTER` есть дополнительный scope-контроль (в основном собственные списки), но это не маскирование, а только ограничение области доступа.

### Где есть маскирование
- Logback использует `%maskedMsg` с `MessageMaskingConverter`.
- Конвертер маскирует телефоны regex-ом и некоторые паттерны имен, а также токены.
- `DenySensitiveTurboFilter` блокирует сообщения с ключевыми словами `qr`, `start_param`, `idempotencyKey`.
- Audit metadata дополнительно санитизируется: чувствительные ключи отбрасываются, похожие на телефон значения редактируются в `[REDACTED]`.

### Где маскирования не видно
- API-ответы и CSV-экспорт guest-list содержат телефон как есть.
- В UI booking нет визуальной маски перед сохранением.

---

## 4) Retention policy (TTL/очистка/анонимизация)

### Что есть
- Локальная очистка истекших HOLD в бронированиях (`cleanupExpired` удаляет `booking_holds` по `expires_at`).
- Для файловых логов установлен `maxHistory=30` (30 дней ротации).
- В схемах есть `expires_at` для отдельных сущностей (holds/invitations/waitlist), но это не равнозначно политике удаления PII в `users/bookings/guest_list_entries`.

### Что отсутствует/неочевидно
- Нет явной централизованной retention policy для PII (сроки хранения по таблицам, legal basis, purge schedule).
- Не найдена автоматическая анонимизация PII в исторических `bookings`, `guest_list_entries`, `users`.
- Не найден пользовательский/админский flow «удалить/анонимизировать пользователя».

---

## 5) Логирование PII и чат-уведомления

### Позитив
- Есть системная маска сообщений в logback (`MessageMaskingConverter`).
- Есть дополнительная фильтрация «чувствительных» логов (`DenySensitiveTurboFilter`).
- Audit metadata санитизируется.

### Риски
- Маскирование зависит от текстовых паттернов и не гарантирует 100% покрытие всех payload-форматов.
- В booking web app есть отправка в HQ чат сообщения, где уходит Telegram user id / display / username и QR-секрет брони (это не телефон, но чувствительный идентификатор доступа).

---

## 6) Экспорт данных и ограничения по ролям

- Экспорт guest-list (`/api/guest-lists/export`) role-gated и scoped.
- Но набор ролей широк для доступа к телефонным данным.
- Экспорт содержит прямой `phone` столбец без маскирования/минимизации.

---

## 7) Удаление/анонимизация пользователя

- Явный механизм удаления или анонимизации пользователя в API/репозиториях **не найден**.
- Текущий `UserRepository` предоставляет только операции чтения.

---

## 8) Риски (приоритизация)

### P0
1. **Экспорт/выдача телефона в открытом виде для широкого набора ролей** в guest-list API/CSV.
2. **Передача QR-секрета брони в HQ-чат** — потенциальный обход инварианта «один Night Pass / антифрод» при компрометации чата.

### P1
1. **Отсутствие явного consent-flow на телефон (`request_contact` / явный consent text + чекбокс).**
2. **Отсутствие формализованной retention policy для PII** (schedules purge/anonymize).
3. **Нет штатного механизма delete/anonymize user** (DSR/GDPR-like сценарии).

### P2
1. **Маскирование логов эвристическое** (regex/keyword), возможно неполное для edge-case форматов.
2. **Нет role-tiered маски в UI/API** (например, host видит только последние 2–4 цифры).

---

## 9) Рекомендации

## 9.1 Политика хранения (data retention)
1. Утвердить матрицу retention по таблицам:
   - `users`: профиль + правовое основание + срок;
   - `bookings`: операционный срок + финансовый/комплаенс срок;
   - `guest_list_entries`: короткий операционный срок, затем анонимизация;
   - `audit_log`: отдельно, с минимизацией PII и immutable-подходом.
2. Ввести регулярные джобы:
   - `purge_expired_operational_data`;
   - `anonymize_historical_pii`.
3. В audit фиксировать кто/когда запустил удаление/анонимизацию и по какому основанию.

## 9.2 Consent и UI-тексты
1. Для Telegram-чата: использовать кнопку с `request_contact` там, где это применимо.
2. Для mini app/web формы телефона:
   - добавить явный consent checkbox (обязательный);
   - сохранить timestamp + source consent (`miniapp_form` / `request_contact`).
3. Рекомендуемый текст согласия (RU):
   - «Нажимая “Подтвердить”, вы соглашаетесь на обработку номера телефона для бронирования, входа и сервисных уведомлений. Данные хранятся ограниченный срок согласно Политике конфиденциальности.»

## 9.3 Контроль доступа и маскирование
1. Ограничить телефон в API/экспорте по принципу need-to-know:
   - promoter/entry-manager: маска по умолчанию (`+7******123`),
   - полное значение только для ролей с обоснованием.
2. Для CSV-экспорта добавить параметр `includeSensitive=true` только для high-privilege ролей + аудит причины.
3. Убрать передачу `qrSecret` в HQ-чат или заменить на безопасный reference/id.

## 9.4 Delete/Anonymize flow
1. Добавить административный/DSR flow:
   - anonymize `users` (username/display_name/phone),
   - scrub в зависимых таблицах (`bookings`, `guest_list_entries`) по политике,
   - исключения для финансовых immutable записей с псевдонимизацией вместо полного удаления.
2. Все операции только через супер-роль + причина + audit trail.

---

## 10) Итог
Текущая реализация содержит базовые механизмы защиты логов и role-based ограничений, но по privacy governance есть критические пробелы: открытая выдача телефона в export/API, отсутствие явного consent-flow на телефон и отсутствие системной retention/anonymization политики.
