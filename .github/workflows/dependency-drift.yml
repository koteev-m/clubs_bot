name: Dependency Drift Report

on:
  schedule:
    - cron: '0 4 * * 1-5'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  dependency-drift:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Set up JDK 21
        uses: actions/setup-java@b36c23c0d998641eff861008f374ee103c25ac73 # v4.4.0
        with:
          distribution: temurin
          java-version: '21'

      - name: Gradle cache & setup
        uses: gradle/actions/setup-gradle@d9c87d481d55275bb5441eef3fe0e46805f9ef70 # v3.5.0
        with:
          cache-disabled: false
          gradle-version: wrapper
          cache-read-only: false
          cache-key-prefix: >
            ${{ runner.os }}-gradle-
            ${{ hashFiles('gradle.properties', 'gradle/libs.versions.toml', 'settings.gradle.kts', 'gradle/wrapper/gradle-wrapper.properties') }}

      - name: Generate dependency drift report
        continue-on-error: ${{ github.event_name == 'workflow_dispatch' }}
        run: ./gradlew dependencyUpdates --no-parallel --console=plain

      - name: Upload dependency drift report
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: dependency-drift-report
          path: "**/build/dependencyUpdates/**"
          if-no-files-found: ignore
