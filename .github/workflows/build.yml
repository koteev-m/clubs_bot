name: build

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      GRADLE_OPTS: "-Dorg.gradle.daemon=true -Dorg.gradle.parallel=true -Dorg.gradle.caching=true -Dorg.gradle.configuration-cache=true"
      KOTLIN_VERSION: "2.2.10"
      KTOR_VERSION: "3.3.0"
      runIT: "false"

    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Setup JDK 21
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "gradle"

      - name: Gradle wrapper validate
        uses: gradle/wrapper-validation-action@4aa08202ed0ea6c4a62d176707f23c606a5fc753

      - name: Show Gradle and env
        run: |
          ./gradlew --version
          echo "KOTLIN_VERSION=$KOTLIN_VERSION"
          echo "KTOR_VERSION=$KTOR_VERSION"

      - name: Lint & Detekt (retry)
        run: |
          set -e
          retry() { n=0; until [ "$n" -ge 3 ]; do "$@" && break; n=$((n+1)); echo "Retry $n..."; sleep 10; done; }
          retry ./gradlew ktlintFormat ktlintCheck detekt --console=plain

      - name: Dependency Guard
        run: ./gradlew dependencyGuard --console=plain -PktorEnforcedVersion=$KTOR_VERSION

      - name: Unit tests
        run: ./gradlew test --console=plain

      - name: Build (retry)
        run: |
          set -e
          retry() { n=0; until [ "$n" -ge 3 ]; do "$@" && break; n=$((n+1)); echo "Retry $n..."; sleep 10; done; }
          retry ./gradlew clean build --console=plain
