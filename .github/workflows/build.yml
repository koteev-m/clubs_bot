name: build

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      GRADLE_OPTS: "-Dorg.gradle.daemon=true -Dorg.gradle.parallel=true -Dorg.gradle.caching=true -Dorg.gradle.configuration-cache=true"
      KOTLIN_VERSION: "2.2.10"
      KTOR_VERSION: "3.3.0"
      runIT: "false"

    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Setup JDK 21
        uses: actions/setup-java@b36c23c0d998641eff861008f374ee103c25ac73 # v4.4.0
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "gradle"

      - name: Gradle wrapper validate
        uses: gradle/wrapper-validation-action@460a3ca55fc5d559238a0efc7fa9f7465df8585d # v3.3.0

      - name: Show Gradle and env
        run: |
          ./gradlew --version
          echo "KOTLIN_VERSION=$KOTLIN_VERSION"
          echo "KTOR_VERSION=$KTOR_VERSION"

      - name: Lint & Detekt (retry)
        run: |
          set -e
          retry() { n=0; until [ "$n" -ge 3 ]; do "$@" && break; n=$((n+1)); echo "Retry $n..."; sleep 10; done; }
          retry ./gradlew ktlintFormat ktlintCheck detekt --console=plain

      - name: Dependency Guard
        run: ./gradlew dependencyGuard --console=plain -PktorEnforcedVersion=$KTOR_VERSION

      - name: Unit tests
        run: ./gradlew test --console=plain

      - name: Build (retry)
        run: |
          set -e
          retry() { n=0; until [ "$n" -ge 3 ]; do "$@" && break; n=$((n+1)); echo "Retry $n..."; sleep 10; done; }
          retry ./gradlew clean build --console=plain
