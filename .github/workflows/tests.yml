name: Tests

on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tests:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      GRADLE_OPTS: "-Dorg.gradle.internal.http.socketTimeout=120000 -Dorg.gradle.internal.http.connectionTimeout=60000"

    services:
      postgres:
        image: postgres:16-alpine@sha256:46258a3eb38adf37e77ca5bd41f93ca8b1034f925cf37190a7a8015ba151f3ca
        ports: [ "5432:5432" ]
        env:
          POSTGRES_DB: botdb
          POSTGRES_USER: botuser
          POSTGRES_PASSWORD: botpass
        options: >-
          --health-cmd "pg_isready -U botuser -d botdb"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10

    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Guard: no project-level repositories
        run: |
          set -euo pipefail
          files=$(git ls-files '**/build.gradle' '**/build.gradle.kts' || true)
          [ -z "$files" ] && exit 0

          violations=0
          tmp="$(mktemp)"
          for f in $files; do
            sed -E ':a;/\/\*/{N;/\*\//!ba;s/\/\*.*\*\///g}; s,//.*$,,' "$f" > "$tmp"

            if grep -nE '^[[:space:]]*repositories[[:space:]]*\{' "$tmp"; then
              echo "::error file=$f::Disallowed 'repositories { }' block in $f"
              violations=1
              continue
            fi

            if ! awk -v file="$f" '
              function trim(s) {
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", s)
                return s
              }
              { lines[NR] = $0 }
              END {
                bad = 0
                for (i = 1; i <= NR; i++) {
                  if (match(lines[i], /^[[:space:]]*repositories[[:space:]]*$/)) {
                    j = i + 1
                    while (j <= NR) {
                      line = trim(lines[j])
                      if (line == "") {
                        j++
                        continue
                      }
                      if (line ~ /^\{/ ) {
                        printf("::error file=%s::Disallowed 'repositories { }' block (newline style) near line %d\n", file, i)
                        bad = 1
                      }
                      break
                    }
                  }
                }
                exit bad
              }
            ' "$tmp"; then
              violations=1
            fi
          done
          rm -f "$tmp"
          exit $violations

      - name: Guard: no dynamic dependency versions
        run: |
          set -euo pipefail
          files=$(git ls-files '**/*.gradle' '**/*.gradle.kts' 'settings.gradle' 'settings.gradle.kts' || true)
          [ -z "$files" ] && exit 0

          violations=0
          tmp="$(mktemp)"
          for f in $files; do
            sed -E ':a;/\/\*/{N;/\*\//!ba;s/\/\*.*\*\///g}; s,//.*$,,' "$f" > "$tmp"

            if grep -nE "version[[:space:]]*=[[:space:]]*[\"'][^\"']*\+[\"']" "$tmp"; then
              echo "::error file=$f::Dynamic version (+) is not allowed in $f"
              violations=1
            fi

            if grep -nE ":[^:@\"']*\+[\"']" "$tmp"; then
              echo "::error file=$f::Dependency coordinates must be pinned (found '+')"
              violations=1
            fi

            if grep -nE "['\"][[:alnum:].-]*latest\.(release|integration)['\"]" "$tmp"; then
              echo "::error file=$f::latest.release/latest.integration are forbidden"
              violations=1
            fi

            if grep -nE "['\"][^'\"]*-SNAPSHOT['\"]" "$tmp"; then
              echo "::error file=$f::-SNAPSHOT versions are not allowed"
              violations=1
            fi

            if grep -nE "['\"]\[[^'\"]+[\)\]]["\']" "$tmp"; then
              echo "::error file=$f::Version ranges are not allowed"
              violations=1
            fi
          done
          rm -f "$tmp"
          exit $violations

      - name: Guard: no dynamic versions in plugin blocks
        run: |
          set -euo pipefail
          files=$(git ls-files '**/build.gradle' '**/build.gradle.kts' 'settings.gradle' 'settings.gradle.kts' || true)
          [ -z "$files" ] && exit 0

          violations=0
          tmp="$(mktemp)"
          for f in $files; do
            sed -E ':a;/\/\*/{N;/\*\//!ba;s/\/\*.*\*\///g}; s,//.*$,,' "$f" > "$tmp"

            if grep -nE "id\([^)]+\)[[:space:]]*(\.|)[[:space:]]*version\([[:space:]]*['\"][^'\"]*\+['\"][[:space:]]*\)" "$tmp"; then
              echo "::error file=$f::Dynamic plugin version (+) is not allowed (Kotlin DSL)"
              violations=1
            fi

            if grep -nE "id[[:space:]]+['\"][^'\"]+['\"][[:space:]]+version[[:space:]]+['\"][^'\"]*\+['\"]" "$tmp"; then
              echo "::error file=$f::Dynamic plugin version (+) is not allowed (Groovy DSL)"
              violations=1
            fi

            if grep -nE "version\([[:space:]]*['\"][^'\"]*(latest\.(release|integration))['\"][[:space:]]*\)" "$tmp"; then
              echo "::error file=$f::latest.release/latest.integration are forbidden in plugin DSL"
              violations=1
            fi

            if grep -nE "version\([[:space:]]*['\"][^'\"]*-SNAPSHOT['\"][[:space:]]*\)" "$tmp"; then
              echo "::error file=$f::-SNAPSHOT plugins are not allowed"
              violations=1
            fi

            if grep -nE "version\([[:space:]]*['\"]\[[^'\"]+[\)\]]["\'][[:space:]]*\)" "$tmp"; then
              echo "::error file=$f::Version ranges are not allowed in plugin DSL"
              violations=1
            fi

            if grep -nE "version[[:space:]]+['\"][^'\"]*(latest\.(release|integration))['\"][[:space:]]*" "$tmp"; then
              echo "::error file=$f::latest.release/latest.integration are forbidden in plugin DSL"
              violations=1
            fi

            if grep -nE "version[[:space:]]+['\"][^'\"]*-SNAPSHOT['\"]" "$tmp"; then
              echo "::error file=$f::-SNAPSHOT plugins are not allowed"
              violations=1
            fi

            if grep -nE "version[[:space:]]+['\"]\[[^'\"]+[\)\]]["\']" "$tmp"; then
              echo "::error file=$f::Version ranges are not allowed in plugin DSL"
              violations=1
            fi
          done
          rm -f "$tmp"
          exit $violations

      - name: Guard: no dynamic versions in version catalogs
        run: |
          set -euo pipefail
          files=$(git ls-files 'gradle/libs.versions.toml' || true)
          [ -z "$files" ] && exit 0

          violations=0
          for f in $files; do
            matches=$(awk 'BEGIN { }
              /^[[:space:]]*#/ { next }
              /"[^"]*\+[^"]*"/ { printf("%d:%s\n", NR, $0) }
              /"[^"]*latest\.(release|integration)[^"]*"/ { printf("%d:%s\n", NR, $0) }
              /"[^"]*-SNAPSHOT[^"]*"/ { printf("%d:%s\n", NR, $0) }
              /"[^"]*\[[^"]+[)\]][^"]*"/ { printf("%d:%s\n", NR, $0) }
            ' "$f" || true)
            if [ -n "$matches" ]; then
              echo "::error file=$f::Dynamic/snapshot/range versions are not allowed in version catalogs"
              echo "$matches"
              violations=1
            fi
          done

          exit $violations

      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@4aa08202ed0ea6c4a62d176707f23c606a5fc753

      - name: Set up JDK 21
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      - name: Env versions
        run: |
          java -version
          ./gradlew --version

      - name: Wait for Postgres (5432)
        run: |
          for i in {1..60}; do
            nc -z 127.0.0.1 5432 && echo "postgres OK" && exit 0
            sleep 1
          done
          echo "postgres not ready" && exit 1

      - name: Run unit tests (retry x3)
        env:
          CI: "true"
        run: |
          set -e
          for i in 1 2 3; do
            extra=""
            if [ "$i" -gt 1 ]; then extra="--refresh-dependencies"; fi
            echo "Attempt $i: ./gradlew clean test --no-configuration-cache $extra"
            if ./gradlew clean test --no-configuration-cache $extra --console=plain --stacktrace; then
              exit 0
            fi
            ./gradlew --stop || true
            echo "Retrying in 20s..."
            sleep 20
          done
          exit 1

      - name: Run integration tests (retry x3)
        env:
          CI: "true"
        run: |
          set -e
          for i in 1 2 3; do
            extra=""
            if [ "$i" -gt 1 ]; then extra="--refresh-dependencies"; fi
            echo "Attempt $i: ./gradlew test -PrunIT=true --no-configuration-cache $extra"
            if ./gradlew test -PrunIT=true --no-configuration-cache $extra --console=plain --stacktrace; then
              exit 0
            fi
            ./gradlew --stop || true
            echo "Retrying in 20s..."
            sleep 20
          done
          exit 1

      - name: Logs policy scan (SEC-02) (retry x2)
        env:
          TELEGRAM_BOT_TOKEN: 111111:TEST_BOT_TOKEN
          NOTIFICATIONS_ENABLED: "false"
          FLYWAY_LOCATIONS: classpath:db/migration/h2
        run: |
          set -e
          for i in 1 2; do
            extra=""
            if [ "$i" -gt 1 ]; then extra="--refresh-dependencies"; fi
            echo "Attempt $i: ./gradlew :app-bot:checkLogsPolicy --no-configuration-cache $extra"
            if ./gradlew :app-bot:checkLogsPolicy --no-configuration-cache $extra --no-daemon --stacktrace; then
              exit 0
            fi
            ./gradlew --stop || true
            echo "Retrying in 20s..."
            sleep 20
          done
          exit 1

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: test-reports
          path: "**/build/reports/tests/**"
          if-no-files-found: ignore

      - name: Upload jacoco reports (optional)
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: jacoco-reports
          path: "**/build/reports/jacoco/**"
          if-no-files-found: ignore
