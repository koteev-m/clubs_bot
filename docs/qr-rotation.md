# Ротация QR-кодов

## Назначение

Валидация QR-токенов для чек-ина поддерживает окно ротации секрета: временно принимается старый `QR_OLD_SECRET` параллельно с основным `QR_SECRET`, чтобы безопасно сменить ключи без блокировки входа гостей. Опционально задаётся дедлайн, после которого старый секрет перестаёт считаться валидным.

## Метрики

| Метрика | Тип | Единицы | Интерпретация |
| --- | --- | --- | --- |
| `ui_checkin_rotation_active` | gauge | 0/1 | 1, если настроен `QR_OLD_SECRET`; 0, если ротация не активна. Готовый индикатор включённости окна. |
| `ui_checkin_rotation_deadline_seconds` | gauge | epoch seconds | Дедлайн завершения окна ротации. Отсутствует, если дедлайн не задан. Значение в прошлом означает, что старый секрет нужно выключить. |
| `ui_checkin_old_secret_fallback_total` | counter | шт. | Количество проверок QR, прошедших валидацию старым секретом. Растёт только при активной ротации. |
| `ui_checkin_qr_invalid_total` | counter | шт. | Некорректные/повреждённые QR (формат/подпись). Рост в период ротации может указывать на рассинхрон секретов. |
| `ui_checkin_qr_expired_total` | counter | шт. | Просроченные QR (TTL/окно). Полезно отслеживать при смене сроков действия. |
| `ui_checkin_qr_scope_mismatch_total` | counter | шт. | QR, не подходящие по клубу/листу. Может всплывать при неверной конфигурации секретов между инстансами. |

## Алерты и пороги

- `ui_checkin_rotation_active=1` и `ui_checkin_rotation_deadline_seconds` в прошлом → алерт на завершение окна (старый секрет пора убирать).
- Резкий рост `ui_checkin_old_secret_fallback_total` за короткое время → сигнал, что клиенты всё ещё используют старые QR (нужно ускорить ротацию/рассылку новых ссылок).
- Пики `ui_checkin_qr_invalid_total` / `ui_checkin_qr_expired_total` / `ui_checkin_qr_scope_mismatch_total` → проверять секреты, TTL и целостность QR.
- Если нужно формализовать пороги: поставить rule на `increase(ui_checkin_rotation_deadline_seconds[1m]) < 0` (дедлайн в прошлом) и на `rate(ui_checkin_old_secret_fallback_total[5m])` выше бэкграундного уровня. Конкретные значения задаются операторами мониторинга.
- Формальные правила алертов и каналы уведомлений для этих метрик описаны в `docs/alerts.md`.

## Runbook при проблемах QR

1. Проверить `/metrics`:
   - `ui_checkin_rotation_active`, `ui_checkin_rotation_deadline_seconds` — активно ли окно и не истёк ли дедлайн.
   - `ui_checkin_old_secret_fallback_total` — растёт ли счётчик (значит, старый секрет используется клиентами).
   - Ошибочные счётчики `ui_checkin_qr_invalid_total` / `ui_checkin_qr_expired_total` / `ui_checkin_qr_scope_mismatch_total` — есть ли всплески.
2. Проверить логи маршрута чек-ина (`checkin.scan ... error=<code> clubId=...`) для конкретных кодов `invalid_or_expired_qr`/`invalid_qr_format`/`empty_qr`.
3. Убедиться, что переменные окружения заданы корректно:
   - `QR_SECRET` — основной секрет.
   - `QR_OLD_SECRET` — старый секрет, удаляется после окончания окна.
   - `QR_ROTATION_DEADLINE_EPOCH` — опциональный дедлайн в epoch seconds.
4. Если дедлайн истёк и `QR_OLD_SECRET` больше не нужен — убрать его из конфигурации и перезапустить сервисы.
5. Если проблема связана с внешними зависимостями (БД/сетевые таймауты) — см. `docs/runtime-db-resiliency.md` и статус `/health`.
6. При необходимости временно заморозить ротацию (оставить только `QR_SECRET`) и перевыпустить QR-коды для затронутых гостей.
