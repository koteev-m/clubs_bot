# Disaster Recovery (DR) и база данных

## Цель и охват
- Минимальные ориентиры: RPO ≤ 15 минут (WAL-архив), RTO ≤ 1 час (автоматизированное развертывание + проверка схемы).
- Среды: prod обязательно; stage используется как «канареечная» среда для проверки миграций и процедур восстановления.

## Бэкапы и PITR
- Хранилище: управляемый PostgreSQL (Cloud SQL/RDS/аналог) c ночными snapshot’ами и WAL-архивированием в объектное хранилище (S3/GCS bucket под управлением infra/platform-команды).
- Retention: nightly snapshots ≥ 14 дней, WAL архивы ≥ 7 дней.
- Общая процедура PITR:
  1. Определить целевое время восстановления T (до инцидента).
  2. Создать новый кластер/БД из последнего full snapshot’а.
  3. Включить восстановление WAL до времени T (PITR) и дождаться окончания реигрыша журналов.
  4. Проверить консистентность состояния (инварианты приложения, критичные таблицы).
  5. При необходимости выполнить миграции до нужной версии (обычно WAL покрывает актуальное состояние).
  6. Переключить трафик на восстановленную БД, оставить исходный инстанс только для forensics.
- Ответственность: конфигурацию бэкапов/WAL поддерживает платформа/infra-команда; доступы/учётки для восстановления хранятся в секрете провайдера и не коммитятся в репозиторий.

## Пробный restore-тест (fire drill)
- Периодичность: не реже одного раза в квартал или после крупных релизов схемы.
- Шаги:
  1. Взять последний prod-снапшот и WAL архивы за выбранный период.
  2. Развернуть отдельный тестовый кластер/БД в изолированном проекте/namespace (без сетевого доступа из prod).
  3. Применить актуальные миграции (через Gradle/CLI) и убедиться, что схема соответствует текущей версии приложения.
  4. Поднять приложение против восстановленной БД с безопасными подменами интеграций: отключённые внешние вебхуки/платежи/уведомления, заменённые токены/секреты.
  5. Прогнать smoke-тест: ключевые сценарии UI/бота (логин, чек-ин/бронирование, отправка уведомлений в песочницу).
  6. Зафиксировать результат: общее время от старта упражнения до успешного smoke, любые проблемы (несоответствие схемы, недостающие миграции, конфиг).
- Ответственность: инициирует платформа/infra-команда совместно с владельцами приложения; отчёты складываются во внутренний wiki/Confluence/Notion.

## Политика миграций (Flyway)
- Режим задаётся переменной `FLYWAY_MODE`: `validate`, `migrate-and-validate`, `off`.
- Значения по умолчанию:
  - `APP_ENV` ∈ {`prod`, `production`, `stage`, `staging`} ⇒ `FLYWAY_MODE=validate` (без `migrate()`).
  - `APP_ENV` ∈ {`local`, `dev`} ⇒ `FLYWAY_MODE=migrate-and-validate` для удобства локалки/ephemeral БД.
- В прод/стейдж приложению запрещено мигрировать на старте: выполняется только `flyway.validate()`; при наличии pending миграций процесс падает, чтобы деплой стал красным.
- Out-of-order миграции: по умолчанию `false`; разрешается только при `APP_ENV` ∈ {`local`, `dev`} и `FLYWAY_OUT_OF_ORDER=true` (логируется WARN).
- CI для прод/стейдж миграций: `.github/workflows/db-migrate.yml` (ручной `workflow_dispatch` с `app_env` или пуш релизного тега) запускает `./gradlew flywayMigrate --console=plain` c `FLYWAY_MODE=migrate-and-validate`.
- Вспомогательные переменные: `FLYWAY_LOCATIONS` (список путей через запятую), `FLYWAY_BASELINE_ON_MIGRATE` (по умолчанию `true`), `FLYWAY_ENABLED` (по умолчанию `true`).

## Пул подключений (Hikari)
- Значения берутся из env; невалидные/вне диапазона значения логируются и заменяются на дефолт.
- Таблица настроек:

| Env | Назначение | Дефолт | Рекомендации (dev/local) | Рекомендации (prod/stage) |
| --- | --- | --- | --- | --- |
| `HIKARI_MAX_POOL_SIZE` | Максимум подключений в пуле (Int, 1–50) | 20 | 5–10 | 10–30 (в зависимости от нагрузки/лимитов БД) |
| `HIKARI_MIN_IDLE` | Минимум idle соединений (Int, 0–max) | 2 | 1–2 | 2–10 |
| `HIKARI_CONN_TIMEOUT_MS` | Таймаут установления соединения, мс (1_000–120_000) | 5_000 | 3_000–10_000 | 5_000–20_000 |
| `HIKARI_VALIDATION_TIMEOUT_MS` | Таймаут проверки соединения, мс (500–60_000) | 2_000 | 1_000–5_000 | 2_000–10_000 |
| `HIKARI_LEAK_DETECTION_MS` | Leak detection, мс (0–600_000; 0 = off) | 10_000 | 0 (обычно off) или 5_000–15_000 при отладке | 10_000–60_000 при расследованиях/профилировании |

- Параметры `APP_ENV`/`FLYWAY_MODE` и таблица выше применяются и для локальной разработки: при отсутствии переменных сохраняется прежнее поведение (пул 20/2/5s/2s/10s, автоприменение миграций в dev/local).
